class CodeTradeController < ApplicationController
        skip_before_filter :verify_authenticity_token

        def read
                limit = params[:limit]
                start = params[:start]
                search = Array.new
                case_search = ""
                if !(params[:query].nil?)
                        #if !(params[:fields].nil?) and !(params[:query].nil?) and params[:query] != "" and params[:fields] != ""
                        allfields = ActiveSupport::JSON.decode(params[:fields]).join('::varchar||') + "::varchar"
                        case_search = allfields + " LIKE '%" + params[:query] + "%'"
                end
                rs = CodeTrade.find(:all, :conditions => case_search, :limit => limit, :offset => start, :order => "id")
                return_data = Hash.new()
                return_data[:totalCount] = CodeTrade.count(:all , :conditions => case_search)
                return_data[:records]   = rs.collect{|u| {
                        :id           => u.id,                       
                        :codetrade    => u.codetrade,
                        :trade        => u.trade,
                        :stdcode      => u.stdcode,
                        :use_status   => (u.use_status == '1') ? true : false
                } }
                render :text => return_data.to_json, :layout => false
        end

	def create
                records = ActiveSupport::JSON.decode(params[:records])
                if records.type == Hash
                        if records["codetrade"] == "" and records["trade"] == "" and records["use_status"] == ""
                                return_data = Hash.new()
                                return_data[:success] = false
                                render :text => return_data.to_json, :layout => false
                        else
                                count_check = CodeTrade.count(:all, :conditions => "codetrade = '#{records["codetrade"]}'")
                                if count_check > 0
                                        return_data = Hash.new()
                                        return_data[:success] = false
                                        return_data[:msg] = "มีรหัสนี้แล้ว"
                                        render :text => return_data.to_json, :layout=>false
                                else
                                        records["use_status"] = (records["use_status"] == true) ? 1 : 0
                                        store = CodeTrade.create(records)
                                        return_data = Hash.new()
                                        return_data[:success] = true
                                        return_data[:records] = {
                                                :id           => store[:id],
                                                :codetrade    => store[:codetrade],
                                                :trade        => store[:trade],
                                                :use_status   => store[:use_status]
                                        }
                                        render :text => return_data.to_json, :layout => false
                                end
                        end
                else
                        render :text => "{success: false}"
                end
	end
	
	def update
                records = ActiveSupport::JSON.decode(params[:records])
                if records.type == Hash
                        count_check = CodeTrade.count(:all , :conditions => "codetrade = '#{records["codetrade"]}' and id <> '#{records["id"]}' ")
                        if count_check > 0
                                return_data = Hash.new()
                                return_data[:success] = false
                                return_data[:msg] = "มีรหัสนี้แล้ว"
                                render :text => return_data.to_json, :layout=>false
                        else
                                update_record = CodeTrade.find(:all , :conditions => "id = '#{records["id"]}'")[0]
                                update_record.codetrade = records["codetrade"]
                                update_record.trade = records["trade"]
                                update_record.use_status = (records["use_status"] == true) ? 1 : 0
                                if update_record.save
                                        return_data = Hash.new()
                                        return_data[:success] = true
                                        return_data[:records]= {
                                                :id             => records["id"],
                                                :codetrade      => records["codetrade"],
                                                :trade          => records["trade"],
                                                :use_status     => (records["use_status"] == true) ? 1 : 0
                                        }
                                        render :text => return_data.to_json, :layout => false
                                else
                                        render :text => "{success:false}"
                                end
                        end
                else
                        render :text => "{success:false}"
                end
	end
	
	def delete
                id = ActiveSupport::JSON.decode(params[:records])
                if CodeTrade.delete(id)
                        render :text => "{success:true, records:{id:id}}"
                else
                        render :text => "{success:false}"
                end
	end
	
	def report
          data = ActiveSupport::JSON.decode(params[:data])
          search = Array.new
          case_search = ""
          if !(data["query"].nil?)
          #if !(data["fields"].nil?) and !(data["query"].nil?) and data["query"] != "" and data["fields"] != ""
                  allfields = ActiveSupport::JSON.decode(data["fields"]).join('::varchar||') + "::varchar"
                  case_search = allfields + " LIKE '%" + data["query"] + "%'"
          end
          @records = CodeTrade.find(:all, :conditions => case_search, :order => "codetrade")
  end
  
  def genres
    case_search = ''
    if !params[:query].nil?
      case_search = "codetrade::varchar like '%#{params[:query]}%' or trade like '%#{params[:query]}%'"
      end
      records = CodeTrade.find(:all,:conditions =>case_search)
      return_data = Hash.new()
      return_data[:success] = true
      return_data[:records]   = records.collect{|u| {   
        :codetrade      => u.codetrade,
        :trade          => u.trade
      } }
      render :text => return_data.to_json, :layout => false
  end
        
end
